#!/bin/bash

# Bolder font rendering
#export FREETYPE_PROPERTIES="cff:no-stem-darkening=0 autofitter:no-stem-darkening=0"

# Use Vulkaninfo to verify if only llvmpipe as vulkan render
# Output true if using llvmpipe and false if using anotherr vulkan render
if vulkaninfo --summary 2> /dev/null | grep 'deviceName' | grep -vq 'llvmpipe'; then
    unset QSG_RENDER_LOOP
    [[ -z $Vulkan_Supported ]] && export Vulkan_Supported=1
else
    # If using mesa amber or virtualization force cairo renderer
    if compgen -G /var/lib/pacman/local/mesa-amber-* || systemd-detect-virt -q; then
        [[ -z $GSK_RENDERER ]] && export GSK_RENDERER="cairo"
    else
        [[ -z $GSK_RENDERER ]] && export GSK_RENDERER="gl"
    fi
fi

if [ "$1" = "wayland" ]; then
    [[ -z $ELECTRON_OZONE_PLATFORM_HINT ]] && export ELECTRON_OZONE_PLATFORM_HINT=auto
    [[ -z $MOZ_ENABLE_WAYLAND ]] && export MOZ_ENABLE_WAYLAND=1
    [[ -z $KWIN_EFFECTS_FORCE_ANIMATIONS ]] && export KWIN_EFFECTS_FORCE_ANIMATIONS=1

    # Less input lag for keyboard
    [[ -z $IBUS_ENABLE_SYNC_MODE ]] && export IBUS_ENABLE_SYNC_MODE=1

    exec --no-startup-id /usr/lib/pam_kwallet_init

else
    # X11 Config
    RESOLUTION="$(xdpyinfo | awk '/dimensions/ {print $2}')"
    SCREEN="$(xrandr | grep 'connected primary' | cut -f1 -d" ")"
    WIDTH=${RESOLUTION//x*}
    HEIGHT=${RESOLUTION//*x}

    [[ -z $KWIN_EFFECTS_FORCE_ANIMATIONS ]] && export KWIN_EFFECTS_FORCE_ANIMATIONS=1
    [[ -z $MOZ_USE_XINPUT2 ]] && export MOZ_USE_XINPUT2=1

fi

# Force language
[[ -z $LANGUAGE ]] && export LANGUAGE=$LANG

# Checks if the shell has already been changed
if [ ! -f "$HOME/.biglinux-shell-changed" ]; then
    biglinux-change-default-shell bash-power
    > "$HOME/.biglinux-shell-changed"
fi

# Use KDE dialog in some GTK apps like Firefox
[[ -z $GTK_USE_PORTAL ]] && export GTK_USE_PORTAL=1

#Faster AMD GPU
if [ $HEIGHT -gt 1400 ]  2>/dev/null; then
    [[ -z $RADV_FORCE_VRS ]] && export RADV_FORCE_VRS=2x2
else
    [[ -z $RADV_FORCE_VRS ]] && export RADV_FORCE_VRS=1x1
fi
    
#Optimization for AMD GPU in kernel 6.6 and before
kernel_version=$(uname -r | grep -oE '[0-9]\.[0-9][0-9]?')
if [[ ${kernel_version/.} -le 66 ]] then
    [[ -z $RADV_PERFTEST ]] && export RADV_PERFTEST=sam,nggc,ext_ms
fi

#Keyboard LED
if [ -e "$HOME/.config/ledkeyboard" ]; then
   big-keyboard-led on
fi

#OBS Studio game capture with vulkan
if [ -e "/usr/bin/obs-vkcapture" ]; then
    [[ -z $OBS_USE_EGL ]] && export OBS_USE_EGL=1
    [[ -z $OBS_VKCAPTURE ]] && export OBS_VKCAPTURE=1
    #Fix MangoHud overlay
    [[ -z $VK_INSTANCE_LAYERS ]] && export VK_INSTANCE_LAYERS=VK_LAYER_MANGOHUD_overlay:VK_LAYER_OBS_vkcapture_64:VK_LAYER_VALVE_steam_overlay_64
fi

# Add this user-places in first login
if [[ ! -e "$HOME/.local/share/user-places-big.xbel" ]]; then
    # Hide recent files in dolphin
    sed -i 's|<GroupState-RecentlySaved-IsHidden>false</GroupState-RecentlySaved-IsHidden>|<GroupState-RecentlySaved-IsHidden>true</GroupState-RecentlySaved-IsHidden>|g' ~/.local/share/user-places.xbel
    > "$HOME/.local/share/user-places-big.xbel"
fi

# Theme, Desktop and JamesDSP configuration in first login
themeFile="/etc/big-default-config/theme"
if [[ -e "$themeFile" && ! -e "$HOME/.big_desktop_theme" ]] || [[ -e "/tmp/big_desktop_theme" && ! -e "$themeFile" ]]; then
    export BIG_THEME="$(<"$themeFile")"
    big-theme-apps --apply $BIG_THEME
    systemctl --user enable big-welcome

    # JamesDSP
    if [[ -e "/etc/big-default-config/jamesdsp" && -e "$HOME/.config/jamesdsp/application.conf" ]] || [[ -e /tmp/big_enable_jamesdsp && -e /livefs-pkgs.txt ]] ; then
        sed -i "s|AutoStartEnabled=false|AutoStartEnabled=true|g" "$HOME/.config/jamesdsp/application.conf"
    else
        sed -i "s|AutoStartEnabled=true|AutoStartEnabled=false|g" "$HOME/.config/jamesdsp/application.conf"
    fi
    
    # Desktop layout configuration
    desktopFile="/etc/big-default-config/desktop"
    if [ ! -e "$HOME/.kdebiglinux/lastlogin" ] && [ -e "$desktopFile" ]; then
        big-theme-plasma --apply $(cut -f2 -d" " "$desktopFile") quiet
    fi
fi


OIFS=$IFS
IFS=$'\n'
# Automatic rename wallpaper if needed
for i in $(grep -o '/usr/share/wallpapers/.*.avif' ~/.config/plasma-org.kde.plasma.desktop-appletsrc); do
    if [[ -e "${i/.avif/.heic}" ]]; then
        sed -i "s|$i|${i/.avif/.heic}|" ~/.config/plasma-org.kde.plasma.desktop-appletsrc
    fi
done
IFS=$OIFS

#Get id from last wallpaper
wallpaperId=${ grep -m1 -Eo '\[Containments\]\[[0-9]{1,5}\]\[Wallpaper\]\[org.kde.image\]' ~/.config/plasma-org.kde.plasma.desktop-appletsrc | awk -F '\\[|\\]' '{print $4}'; }

#Get path from last wallpaper
plasmaWallpaper=${ kreadconfig6 --file ~/.config/plasma-org.kde.plasma.desktop-appletsrc --group Containments --group $wallpaperId --group Wallpaper --group org.kde.image --group General --key Image; }

#Link from wallpaper to ksplash and if need remove file://
ln -sf "${plasmaWallpaper#file://}" /tmp/bigksplash.jpg
chmod 777 /tmp/bigksplash.jpg

nowlogin=$(<"$HOME/.kdebiglinux/lastused")
lastlogin=$(<"$HOME/.kdebiglinux/lastlogin")

# Fix full screen when switch desktop for globalmenu on or off
if [ "$nowlogin" != "$lastlogin" ]; then
    if [ "$(<"$HOME/.config/kwin_maximized_disable")" = "1" ]; then
        sed -i 's|"custom_chrome_frame":true|"custom_chrome_frame":false|g' ~/.config/chromium/Default/Preferences ~/.config/google-chrome/Default/Preferences ~/.config/BraveSoftware/Brave-Browser/Default/Preferences
        sed -i 's|user_pref("browser.tabs.InTitlebar", 1);|user_pref("browser.tabs.InTitlebar", 0);|g' ~/.mozilla/firefox/*.default/prefs.js
        #Kwin
        sed -i '/BorderlessMaximizedWindows=false/d' ~/.config/kwinrc
    else
        #Chromium Brave Chrome
        sed -i 's|"custom_chrome_frame":false|"custom_chrome_frame":true|g' ~/.config/chromium/Default/Preferences ~/.config/google-chrome/Default/Preferences ~/.config/BraveSoftware/Brave-Browser/Default/Preferences
        #Firefox
        sed -i 's|user_pref("browser.tabs.InTitlebar", 0);|user_pref("browser.tabs.InTitlebar", 1);|g' ~/.mozilla/firefox/*.default/prefs.js
        #Menubar to kde apps
        sed -i '/MenuBar=Disabled/d' ~/.config/okularrc
        #Kwin
        sed -i '/BorderlessMaximizedWindows=true/d' ~/.config/kwinrc
    fi
fi

echo "$nowlogin" > "$HOME/.kdebiglinux/lastlogin"

# Alert if free space is low than 5000
if [ ! -e "$HOME/.config/freespacenotifierrc" ] && [ ! -e "/livefs-pkgs.txt" ]; then
    echo '[General]
minimumSpace=5000' > "$HOME/.config/freespacenotifierrc"
fi

export XDG_SESSION_DESKTOP=KDE

# Enable support to import ssh key
eval "$(ssh-agent -s)"

portal-kde-verify.sh &

# In some laptops backlight not restore correctly, try fix this
sudo biglinux-backlight-restore 2> /dev/null &

# Fix accent problem in GTK
if [[ ! -e ~/.config/big_enabled_fcitx || -e /livefs-pkgs.txt ]] && [[ "$1" = "wayland" && -e /usr/share/applications/fcitx5-wayland-launcher.desktop ]] && ! grep -q 'InputMethod\[$e\]=' "$HOME/.config/kwinrc"; then
    # Create file to only enable one time
    > ~/.config/big_enabled_fcitx

    # Add without [ and ] because is incompatible with kwriteconfig6
    kwriteconfig6 --group "Wayland" --key 'InputMethod$e' --file "$HOME/.config/kwinrc" "/usr/share/applications/fcitx5-wayland-launcher.desktop"

    # Fix [$e]
    sed -i 's|InputMethod$e|InputMethod[$e]|g' "$HOME/.config/kwinrc"
fi

exec startplasma-$XDG_SESSION_TYPE
