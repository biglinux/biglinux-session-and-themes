#!/bin/bash

# BigLinux first login theme and configuration application
# Applies theme, JamesDSP, and display profile settings from live session

CONFIG_DIR="/etc/big-default-config"

if [[ ! -e "$HOME/.local/share/user-places-big.xbel" ]]; then
    # Hide recent files in dolphin
    sed -i 's|<GroupState-RecentlySaved-IsHidden>false</GroupState-RecentlySaved-IsHidden>|<GroupState-RecentlySaved-IsHidden>true</GroupState-RecentlySaved-IsHidden>|g' ~/.local/share/user-places.xbel
    > "$HOME/.local/share/user-places-big.xbel"
fi

# Theme configuration
THEME_FILE="$CONFIG_DIR/theme"

if [[ -e "$THEME_FILE" || ! -e "$HOME/.big_desktop_theme" || ! -e "/tmp/big_desktop_theme" ]]; then
    export BIG_THEME="$(<"$THEME_FILE")"
    big-theme-apps --apply $BIG_THEME
    systemctl --user enable big-welcome
fi

# JamesDSP configuration - apply if flag exists
JAMESDSP_FLAG="$CONFIG_DIR/jamesdsp"

if [[ -e "$JAMESDSP_FLAG" && -e "/usr/bin/jamesdsp" && -e "$HOME/.config/jamesdsp/application.conf" ]] || [[ -e /tmp/big_enable_jamesdsp && -e /livefs-pkgs.txt ]] ; then
    sed -i "s|AutoStartEnabled=false|AutoStartEnabled=true|g" "$HOME/.config/jamesdsp/application.conf"
else
    sed -i "s|AutoStartEnabled=true|AutoStartEnabled=false|g" "$HOME/.config/jamesdsp/application.conf"
fi

# ICC/Display profile configuration - apply if flag exists
DISPLAY_PROFILE_FLAG="$CONFIG_DIR/display-profile"

if [[ -e "$DISPLAY_PROFILE_FLAG" && -e "/usr/share/color/icc/colord/ECI-RGBv1.icc"  ]]; then
        icc_profile_apply enable 2>/dev/null
fi
